<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Keuangan Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- 
        Chosen Palette: Modern Minimalist
        Application Structure Plan: Desain dirombak total untuk menghilangkan Glassmorphism dan Dark Mode, diganti dengan gaya "Claymorphism" yang lebih bersih dan modern. Tujuannya adalah menciptakan tampilan yang "biasa tapi tidak biasa"—terlihat profesional dan mudah dibaca (biasa), namun memiliki karakter unik melalui penggunaan shadow yang tegas, border halus, dan palet warna yang berkelas (tidak biasa). Semua fungsionalitas dan animasi dipertahankan untuk pengalaman pengguna yang dinamis.
        Visualization & Content Choices:
        - KPI Cards (Inform): Menggunakan panel putih solid dengan `box-shadow` yang tegas dan border halus untuk menciptakan efek 3D yang subtle.
        - Charts (Compare/Organize): Ditempatkan dalam panel yang sama untuk konsistensi visual. Warna grafik disesuaikan dengan palet baru yang lebih segar. Grafik kategori diganti dengan grafik tren laba bersih untuk wawasan bisnis yang lebih baik.
        - Transaction Table (Organize): Dibuat lebih bersih. Ditambahkan fungsi Search dan Export CSV. Disembunyikan saat mode perbandingan untuk fokus pada analisis.
        - Confirmation Modal (Interaction): Modal konfirmasi kustom ditambahkan sebelum menghapus data untuk mencegah kesalahan pengguna.
        - Comparison Mode (Interaction): Fitur perbandingan ditambahkan dengan UI khusus untuk memilih dua periode, memberikan kemampuan analisis YoY dan MoM.
        - Animations: Animasi 'fade-in' dan 'typing' dipertahankan untuk memberikan kesan premium.
        - Data Storage: Logic is refactored from localStorage to Firebase Firestore for real-time collaboration.
        CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f4f5; /* Zinc 100 */
        }
        .panel {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }
        .compare-btn-active {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
        }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: #4338ca; } }
        .typing-effect {
            display: inline-block;
            overflow: hidden;
            white-space: nowrap;
            border-right: .15em solid #4338ca;
            animation: typing 2.5s steps(30, end), blink-caret .75s step-end infinite;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        .chart-container { position: relative; width: 100%; height: 320px; }
    </style>
</head>
<body class="text-zinc-800">

    <div id="app" class="container mx-auto p-4 md:p-6">
        
        <header class="text-center mb-8 pt-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-zinc-900">Dasbor Keuangan Anda</h1>
            <p id="greeting" class="text-lg h-7 mt-2 text-indigo-700 font-medium">Memuat...</p>
        </header>

        <main class="opacity-0 transition-opacity duration-500">
            <!-- Filter Section -->
            <div class="mb-4 flex justify-center items-center gap-4">
                <div id="standard-filters" class="flex flex-wrap justify-center gap-2 md:gap-4">
                    <div class="relative">
                        <select id="year-filter" class="w-32 appearance-none rounded-lg border border-zinc-300 bg-white py-2 pl-3 pr-8 text-sm font-medium text-zinc-700 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-zinc-700"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                    </div>
                    <div class="relative">
                        <select id="month-filter" class="w-40 appearance-none rounded-lg border border-zinc-300 bg-white py-2 pl-3 pr-8 text-sm font-medium text-zinc-700 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-zinc-700"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                    </div>
                </div>
                <button id="toggle-compare-btn" class="flex-shrink-0 flex items-center gap-2 rounded-lg border border-zinc-300 bg-white py-2 px-4 text-sm font-medium text-zinc-700 shadow-sm hover:bg-zinc-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                    <span>Bandingkan</span>
                </button>
            </div>
            
            <div id="comparison-filters" class="hidden mb-8 p-4 panel rounded-2xl">
                <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-4">
                     <div class="text-center md:text-left flex-shrink-0">
                        <p class="font-bold text-indigo-700">Mode Perbandingan Aktif</p>
                        <p class="text-xs text-zinc-500">Pilih dua periode untuk dibandingkan</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <p class="font-semibold text-zinc-600">Periode A:</p>
                        <select id="year-filter-a" class="w-28 appearance-none rounded-lg border border-zinc-300 bg-white py-2 pl-3 pr-8 text-sm"></select>
                        <select id="month-filter-a" class="w-32 appearance-none rounded-lg border border-zinc-300 bg-white py-2 pl-3 pr-8 text-sm"></select>
                    </div>
                     <p class="font-bold text-zinc-400 hidden md:block">vs</p>
                     <div class="flex items-center gap-2">
                        <p class="font-semibold text-zinc-600">Periode B:</p>
                        <select id="year-filter-b" class="w-28 appearance-none rounded-lg border border-zinc-300 bg-white py-2 pl-3 pr-8 text-sm"></select>
                        <select id="month-filter-b" class="w-32 appearance-none rounded-lg border border-zinc-300 bg-white py-2 pl-3 pr-8 text-sm"></select>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <section id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-8"></section>
            
            <!-- Charts Section -->
            <section id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8"></section>

            <!-- Transactions Section -->
            <section id="transactions-section" class="panel p-4 md:p-6 rounded-2xl opacity-0"></section>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- PENTING: KONFIGURASI FIREBASE ANDA ---
            // Salin objek `firebaseConfig` dari proyek Firebase Anda dan tempel di bawah ini untuk menggantikan yang contoh.
            const firebaseConfig = {
            apiKey: "AIzaSyDuvVv9JE0qXOsbH94XgStuLBzdDOlPaiA",
            authDomain: "dasbor-keuangan-kost.firebaseapp.com",
            projectId: "dasbor-keuangan-kost",
            storageBucket: "dasbor-keuangan-kost.firebasestorage.app",
            messagingSenderId: "119938039054",
            appId: "1:119938039054:web:343aac05e7b0e88354eb5f"
            };


            let db, auth;
            try {
                if (firebaseConfig.apiKey.startsWith("GANTI_DENGAN")) {
                    throw new Error("Konfigurasi Firebase belum diisi.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                document.body.innerHTML = `<div class="text-center p-8 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-2xl mx-auto mt-10">
                    <h2 class="font-bold text-xl mb-2">Gagal Menginisialisasi Database</h2>
                    <p>Pastikan Anda sudah mengisi variabel <strong>firebaseConfig</strong> di dalam file HTML dengan konfigurasi dari proyek Firebase Anda.</p>
                </div>`;
                return;
            }

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                document.body.innerHTML = '<p class="text-center text-red-500 p-8">Gagal melakukan autentikasi.</p>';
                return;
            }

            const transactionCollectionRef = collection(db, "transactions");

            const state = { 
                transactions: [], 
                currentYear: new Date().getFullYear(),
                currentMonth: 'Semua Bulan',
                isComparing: false,
                periodA: { year: new Date().getFullYear(), month: 'Semua Bulan' },
                periodB: { year: new Date().getFullYear() - 1, month: 'Semua Bulan' },
                searchTerm: '',
                charts: {}, 
                transactionIdToDelete: null 
            };
            
            const ALL_MONTHS = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

            const formatCurrency = value => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
            
            const openModal = (modal, content) => {
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); }, 10);
            };
            
            const closeModal = (modal, content) => {
                modal.classList.add('opacity-0');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            const renderGreeting = () => {
                const hour = new Date().getHours();
                let text = "Selamat Datang, Bos!";
                if (hour < 11) text = "Selamat Pagi, Bos!";
                else if (hour < 15) text = "Selamat Siang, Bos!";
                else if (hour < 19) text = "Selamat Sore, Bos!";
                else text = "Selamat Malam, Bos!";
                document.getElementById('greeting').innerHTML = `<span class="typing-effect">${text}</span>`;
            };

            const setupFilters = () => {
                const yearFilter = document.getElementById('year-filter');
                const monthFilter = document.getElementById('month-filter');
                const yearFilterA = document.getElementById('year-filter-a');
                const monthFilterA = document.getElementById('month-filter-a');
                const yearFilterB = document.getElementById('year-filter-b');
                const monthFilterB = document.getElementById('month-filter-b');
                const years = [...new Set(state.transactions.map(t => new Date(t.date).getFullYear()))];
                const currentY = new Date().getFullYear();
                if (!years.includes(currentY)) years.push(currentY);
                years.sort((a,b) => b - a);
                const yearOptions = years.map(y => `<option value="${y}">${y}</option>`).join('');
                [yearFilter, yearFilterA, yearFilterB].forEach(el => { if(el) el.innerHTML = yearOptions; });
                if(yearFilter) yearFilter.value = state.currentYear;
                if(yearFilterA) yearFilterA.value = state.periodA.year;
                if(yearFilterB) yearFilterB.value = state.periodB.year;
                const monthOptions = ['Semua Bulan', ...ALL_MONTHS].map(m => `<option value="${m}">${m}</option>`).join('');
                [monthFilter, monthFilterA, monthFilterB].forEach(el => { if(el) el.innerHTML = monthOptions; });
                if(monthFilter) monthFilter.value = state.currentMonth;
                if(monthFilterA) monthFilterA.value = state.periodA.month;
                if(monthFilterB) monthFilterB.value = state.periodB.month;
                if(yearFilter) yearFilter.addEventListener('change', e => { state.currentYear = parseInt(e.target.value); renderDashboard(); });
                if(monthFilter) monthFilter.addEventListener('change', e => { state.currentMonth = e.target.value; renderDashboard(); });
                if(yearFilterA) yearFilterA.addEventListener('change', e => { state.periodA.year = parseInt(e.target.value); renderDashboard(); });
                if(monthFilterA) monthFilterA.addEventListener('change', e => { state.periodA.month = e.target.value; renderDashboard(); });
                if(yearFilterB) yearFilterB.addEventListener('change', e => { state.periodB.year = parseInt(e.target.value); renderDashboard(); });
                if(monthFilterB) monthFilterB.addEventListener('change', e => { state.periodB.month = e.target.value; renderDashboard(); });
            };
            
            const getTransactionsForPeriod = (period) => {
                return state.transactions.filter(t => {
                    const d = new Date(t.date);
                    const yearMatch = d.getFullYear() === period.year;
                    const monthMatch = period.month === 'Semua Bulan' || d.getMonth() === ALL_MONTHS.indexOf(period.month);
                    return yearMatch && monthMatch;
                });
            };

            const getFilteredTransactions = (ignoreSearch = false) => {
                 return state.transactions.filter(t => {
                    const d = new Date(t.date);
                    const yearMatch = d.getFullYear() === state.currentYear;
                    const monthMatch = state.currentMonth === 'Semua Bulan' || d.getMonth() === ALL_MONTHS.indexOf(state.currentMonth);
                    const searchMatch = ignoreSearch || t.description.toLowerCase().includes(state.searchTerm.toLowerCase());
                    return yearMatch && monthMatch && searchMatch;
                });
            };

            const calculateMetrics = (transactions) => {
                const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                const expense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                return { income, expense, net: income - expense };
            };

            const renderSummaryCards = () => {
                const container = document.getElementById('summary-cards');
                container.innerHTML = '';
                const cashBalance = state.transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0) - state.transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);

                if (state.isComparing) {
                    const metricsA = calculateMetrics(getTransactionsForPeriod(state.periodA));
                    const metricsB = calculateMetrics(getTransactionsForPeriod(state.periodB));
                    const metricsData = [
                        { title: 'Pemasukan', a: metricsA.income, b: metricsB.income },
                        { title: 'Pengeluaran', a: metricsA.expense, b: metricsB.expense },
                        { title: 'Laba Bersih', a: metricsA.net, b: metricsB.net },
                    ];
                    metricsData.forEach(m => {
                        const diff = m.a - m.b;
                        const percent = m.b === 0 ? (m.a > 0 ? 100 : 0) : (diff / m.b) * 100;
                        const color = diff >= 0 ? 'text-green-600' : 'text-red-600';
                        const arrow = diff >= 0 ? '▲' : '▼';
                        container.innerHTML += `
                            <div class="panel p-5 rounded-2xl opacity-0 card-animate">
                                <h3 class="text-sm font-semibold text-zinc-500 mb-2">${m.title}</h3>
                                <p class="text-xl font-bold">${formatCurrency(m.a)}</p>
                                <p class="text-sm text-zinc-400">vs ${formatCurrency(m.b)}</p>
                                <p class="text-lg font-bold mt-2 ${color}">${arrow} ${percent.toFixed(1)}%</p>
                            </div>`;
                    });
                     container.innerHTML += `<div class="panel p-5 rounded-2xl opacity-0 card-animate"><h3 class="text-sm font-semibold text-zinc-500">Saldo Kas Total</h3><p class="text-2xl font-bold">${formatCurrency(cashBalance)}</p></div>`
                } else {
                    const metrics = calculateMetrics(getFilteredTransactions(true));
                    const cardsData = [
                        { title: 'Total Pemasukan', value: metrics.income, icon: 'M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z', color: 'green' },
                        { title: 'Total Pengeluaran', value: metrics.expense, icon: 'M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z', color: 'red' },
                        { title: 'Laba / Rugi Bersih', value: metrics.net, icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z', color: 'blue' },
                        { title: 'Saldo Kas (Total)', value: cashBalance, icon: 'M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3', color: 'indigo' },
                    ];
                     cardsData.forEach((d, i) => {
                        container.innerHTML += `
                            <div class="panel p-5 rounded-2xl flex items-center gap-4 card-animate opacity-0" style="animation-delay: ${i*0.1}s;">
                                <div class="p-3 bg-${d.color}-100 rounded-xl"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-${d.color}-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="${d.icon}" /></svg></div>
                                <div>
                                    <h3 class="text-sm font-semibold text-zinc-500">${d.title}</h3>
                                    <p class="text-2xl font-bold">${formatCurrency(d.value)}</p>
                                </div>
                            </div>`;
                    });
                }
            };

            const renderTransactionTable = () => {
                const container = document.getElementById('transactions-section');
                container.style.animationDelay = '0.5s';
                container.classList.add('fade-in-up');

                if (state.isComparing) {
                    container.innerHTML = `<p class="text-center text-zinc-500 p-8">Tabel transaksi disembunyikan saat mode perbandingan aktif untuk fokus pada analisis.</p>`;
                    return;
                }
                 container.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                        <div class="w-full md:w-auto">
                            <h3 class="text-xl font-semibold text-zinc-800">Riwayat Transaksi</h3>
                            <p class="text-sm text-zinc-500">(<span id="transaction-period-label">${state.currentMonth}, ${state.currentYear}</span>)</p>
                        </div>
                        <div class="w-full md:w-auto flex flex-col sm:flex-row gap-2">
                            <div class="relative flex-grow">
                                <input type="search" id="search-input" placeholder="Cari keterangan..." class="w-full pl-10 pr-4 py-2 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                            </div>
                            <button id="export-btn" class="flex-shrink-0 flex items-center justify-center gap-2 bg-white border border-zinc-300 text-zinc-700 font-bold py-2 px-4 rounded-lg hover:bg-zinc-100 transition-all">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                               <span>Ekspor</span>
                            </button>
                            <button id="add-transaction-btn" class="flex-shrink-0 flex items-center justify-center gap-2 bg-zinc-900 text-white font-bold py-2 px-4 rounded-lg hover:bg-zinc-700 transition-all transform hover:scale-105">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                <span>Tambah</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto w-full">
                        <table class="min-w-full text-sm text-left">
                            <thead class="border-b-2 border-zinc-200"><tr>
                                <th class="p-3 font-semibold text-zinc-500">Tanggal</th>
                                <th class="p-3 font-semibold text-zinc-500">Keterangan</th>
                                <th class="p-3 font-semibold text-zinc-500 text-right">Jumlah</th>
                                <th class="p-3 font-semibold text-zinc-500 text-center">Aksi</th>
                            </tr></thead>
                            <tbody id="transaction-table-body"></tbody>
                        </table>
                    </div>`;
                
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = state.searchTerm;
                    searchInput.addEventListener('input', (e) => { state.searchTerm = e.target.value; renderTransactionTable(); });
                }
                
                const exportBtn = document.getElementById('export-btn');
                if (exportBtn) exportBtn.addEventListener('click', exportDataToCSV);

                const addBtn = document.getElementById('add-transaction-btn');
                if (addBtn) addBtn.addEventListener('click', () => openModal(document.getElementById('transaction-modal'), document.getElementById('modal-content')));
                
                const tbody = document.getElementById('transaction-table-body');
                tbody.innerHTML = '';
                const filtered = getFilteredTransactions().sort((a, b) => new Date(b.date) - new Date(a.date));

                if (filtered.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-zinc-500">Tidak ada transaksi yang cocok.</td></tr>`;
                    return;
                }
                
                filtered.forEach((t, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-zinc-200/80 opacity-0';
                    row.style.animation = `fadeInUp 0.5s ease-out ${index * 0.05}s forwards`;
                    row.innerHTML = `
                        <td class="p-3">${new Date(t.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</td>
                        <td class="p-3">${t.description}</td>
                        <td class="p-3 text-right font-semibold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'} ${formatCurrency(t.amount)}</td>
                        <td class="p-3 text-center"><button data-id="${t.id}" class="delete-btn text-zinc-400 hover:text-red-500 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td>`;
                    tbody.appendChild(row);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', e => { state.transactionIdToDelete = e.currentTarget.dataset.id; openConfirmationModal(); });
                });
            };

            const renderCharts = () => {
                const container = document.getElementById('charts-section');
                container.innerHTML = '';
                const chartOptions = { responsive: true, maintainAspectRatio: false };

                if(state.isComparing) {
                    container.innerHTML = `
                        <div class="panel p-4 rounded-2xl">
                            <h3 class="text-lg font-semibold text-center text-zinc-700 mb-2">Perbandingan Laba Bersih</h3>
                            <div class="chart-container"><canvas id="comparisonProfitChart"></canvas></div>
                        </div>
                        <div class="panel p-4 rounded-2xl">
                            <h3 class="text-lg font-semibold text-center text-zinc-700 mb-2">Perbandingan Pengeluaran</h3>
                            <div class="chart-container"><canvas id="comparisonExpenseChart"></canvas></div>
                        </div>`;
                    
                    const dataA = { year: state.periodA.year, months: ALL_MONTHS.map((m, i) => calculateMetrics(getTransactionsForPeriod({year: state.periodA.year, month: m})))};
                    const dataB = { year: state.periodB.year, months: ALL_MONTHS.map((m, i) => calculateMetrics(getTransactionsForPeriod({year: state.periodB.year, month: m})))};
                    
                    if(state.charts.compProfit) state.charts.compProfit.destroy();
                    state.charts.compProfit = new Chart(document.getElementById('comparisonProfitChart').getContext('2d'), { type: 'line', data: { labels: ALL_MONTHS, datasets: [ { label: `Laba ${dataA.year}`, data: dataA.months.map(d=>d.net), borderColor: '#4f46e5', tension: 0.1, fill: false }, { label: `Laba ${dataB.year}`, data: dataB.months.map(d=>d.net), borderColor: '#a1a1aa', tension: 0.1, fill: false, borderDash: [5, 5] } ]}, options: chartOptions });
                    
                    if(state.charts.compExpense) state.charts.compExpense.destroy();
                    state.charts.compExpense = new Chart(document.getElementById('comparisonExpenseChart').getContext('2d'), { type: 'bar', data: { labels: ALL_MONTHS, datasets: [ { label: `Pengeluaran ${dataA.year}`, data: dataA.months.map(d=>d.expense), backgroundColor: 'rgba(59, 130, 246, 0.7)' }, { label: `Pengeluaran ${dataB.year}`, data: dataB.months.map(d=>d.expense), backgroundColor: 'rgba(209, 213, 219, 0.7)' } ]}, options: chartOptions });

                } else {
                     container.innerHTML = `
                        <div class="panel p-4 rounded-2xl">
                            <h3 class="text-lg font-semibold text-center text-zinc-700 mb-2">Pemasukan vs Pengeluaran</h3>
                            <div class="chart-container"><canvas id="incomeExpenseChart"></canvas></div>
                        </div>
                        <div class="panel p-4 rounded-2xl">
                            <h3 class="text-lg font-semibold text-center text-zinc-700 mb-2">Tren Laba Bersih</h3>
                            <div class="chart-container"><canvas id="netProfitTrendChart"></canvas></div>
                        </div>`;
                    const monthlyData = ALL_MONTHS.map((m, i) => calculateMetrics(getTransactionsForPeriod({year: state.currentYear, month: m})));
                    
                    if(state.charts.incomeExpense) state.charts.incomeExpense.destroy();
                    state.charts.incomeExpense = new Chart(document.getElementById('incomeExpenseChart').getContext('2d'), { type: 'bar', data: { labels: ALL_MONTHS, datasets: [ { label: 'Pemasukan', data: monthlyData.map(d=>d.income), backgroundColor: 'rgba(59, 130, 246, 0.7)'}, { label: 'Pengeluaran', data: monthlyData.map(d=>d.expense), backgroundColor: 'rgba(234, 179, 8, 0.7)' } ]}, options: chartOptions });
                    
                    if(state.charts.netProfit) state.charts.netProfit.destroy();
                    state.charts.netProfit = new Chart(document.getElementById('netProfitTrendChart').getContext('2d'), { type: 'line', data: { labels: ALL_MONTHS, datasets: [{ label: 'Laba Bersih', data: monthlyData.map(d => d.net), fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)', borderColor: 'rgba(79, 70, 229, 1)', tension: 0.4 }] }, options: { ...chartOptions, plugins: { legend: { display: false }} } });
                }
            };

            const exportDataToCSV = () => {
                if (state.transactions.length === 0) {
                    alert("Tidak ada data untuk diekspor.");
                    return;
                }
                const headers = "Tanggal,Keterangan,Tipe,Jumlah (Rp)\n";
                const rows = state.transactions.map(t => `"${new Date(t.date).toLocaleDateString('id-ID')}","${t.description}","${t.type}",${t.amount}`).join("\n");
                const csvContent = "data:text/csv;charset=utf-8," + headers + rows;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `laporan_keuangan_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const renderModals = () => {
                const container = document.getElementById('modal-container');
                container.innerHTML = `
                    <div id="transaction-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex justify-center items-center p-4 opacity-0 transition-opacity duration-300">
                        <div id="modal-content" class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md mx-4 transform scale-95 transition-transform duration-300">
                            <h3 class="text-xl font-bold mb-4 text-zinc-800">Tambah Transaksi Baru</h3>
                            <form id="transaction-form">
                                <div class="mb-4">
                                    <label for="date" class="block text-sm font-medium text-zinc-700">Tanggal</label>
                                    <input type="date" id="date" name="date" class="mt-1 block w-full bg-zinc-50 border-zinc-300 rounded-lg shadow-sm" required>
                                </div>
                                <div class="mb-4">
                                    <label for="description" class="block text-sm font-medium text-zinc-700">Keterangan</label>
                                    <input type="text" id="description" name="description" class="mt-1 block w-full bg-zinc-50 border-zinc-300 rounded-lg shadow-sm" placeholder="Contoh: Bayar listrik Juni" required>
                                </div>
                                <div class="mb-4">
                                    <label for="type" class="block text-sm font-medium text-zinc-700">Tipe</label>
                                    <select id="type" name="type" class="mt-1 block w-full bg-zinc-50 border-zinc-300 rounded-lg shadow-sm"><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option></select>
                                </div>
                                <div class="mb-4">
                                    <label for="amount" class="block text-sm font-medium text-zinc-700">Jumlah (Rp)</label>
                                    <input type="number" id="amount" name="amount" class="mt-1 block w-full bg-zinc-50 border-zinc-300 rounded-lg shadow-sm" placeholder="500000" required>
                                </div>
                                <div class="flex justify-end gap-3 mt-6">
                                    <button type="button" id="cancel-btn" class="bg-zinc-200 text-zinc-800 font-bold py-2 px-4 rounded-lg">Batal</button>
                                    <button type="submit" class="bg-zinc-900 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div id="confirmation-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex justify-center items-center p-4 opacity-0 transition-opacity duration-300">
                        <div id="confirmation-modal-content" class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm mx-4 transform scale-95 transition-transform duration-300 text-center">
                           <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                           <h3 class="text-lg font-medium mt-4 text-zinc-800">Konfirmasi Penghapusan</h3>
                           <p class="text-sm text-zinc-500 mt-2">Apakah Anda yakin? Tindakan ini tidak dapat dibatalkan.</p>
                           <div class="flex justify-center gap-4 mt-6">
                               <button type="button" id="cancel-delete-btn" class="bg-zinc-200 text-zinc-800 font-bold py-2 px-6 rounded-lg">Batal</button>
                               <button type="button" id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Ya, Hapus</button>
                           </div>
                        </div>
                    </div>`;
                
                const transactionModal = document.getElementById('transaction-modal');
                const transactionModalContent = document.getElementById('modal-content');
                const confirmationModal = document.getElementById('confirmation-modal');
                const confirmationModalContent = document.getElementById('confirmation-modal-content');
                
                const form = document.getElementById('transaction-form');
                document.getElementById('cancel-btn').addEventListener('click', () => closeModal(transactionModal, transactionModalContent));
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newTransaction = { 
                        date: form.date.value, 
                        description: form.description.value, 
                        type: form.type.value, 
                        amount: parseInt(form.amount.value) 
                    };
                    await addDoc(transactionCollectionRef, newTransaction);
                    form.reset();
                    document.getElementById('date').valueAsDate = new Date();
                    closeModal(transactionModal, transactionModalContent);
                });

                document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal(confirmationModal, confirmationModalContent));
                document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                    await deleteDoc(doc(db, "transactions", state.transactionIdToDelete));
                    closeModal(confirmationModal, confirmationModalContent);
                });
            };

            window.openConfirmationModal = () => {
                const modal = document.getElementById('confirmation-modal');
                const content = document.getElementById('confirmation-modal-content');
                openModal(modal, content);
            };
            
            const setupToggleCompare = () => {
                const btn = document.getElementById('toggle-compare-btn');
                const standardFilters = document.getElementById('standard-filters');
                const comparisonFilters = document.getElementById('comparison-filters');
                btn.addEventListener('click', () => {
                    state.isComparing = !state.isComparing;
                    standardFilters.classList.toggle('hidden', state.isComparing);
                    comparisonFilters.classList.toggle('hidden', !state.isComparing);
                    btn.classList.toggle('compare-btn-active', state.isComparing);
                    renderDashboard();
                });
            }
            
            const renderDashboard = () => {
                setupFilters();
                renderSummaryCards();
                renderTransactionTable();
                renderCharts();
                document.querySelectorAll('.card-animate').forEach((el, index) => {
                    el.style.animation = 'none';
                    el.offsetHeight;
                    el.style.animation = `fadeInUp 0.5s ease-out ${index * 0.1}s forwards`;
                });
            };

            const init = () => {
                const now = new Date();
                state.currentYear = now.getFullYear();
                state.currentMonth = ALL_MONTHS[now.getMonth()];
                state.periodA.year = now.getFullYear();
                state.periodA.month = ALL_MONTHS[now.getMonth()];
                state.periodB.year = now.getFullYear() - 1;
                state.periodB.month = ALL_MONTHS[now.getMonth()];
                
                renderGreeting();
                renderModals();
                setupToggleCompare();
                
                onSnapshot(transactionCollectionRef, (snapshot) => {
                    state.transactions = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
                    document.querySelector('main').classList.remove('opacity-0');
                    renderDashboard();
                });
            };

            init();
        });
    </script>
</body>
</html>
